# AGENTS.md – How to work on this repo

## 開発の進め方

- テスト駆動開発を行ってください。まずはテストから作ってください。
- 最初に設定した要件をすべて満たしたとテスト結果で証明できるまで開発を止めないでください。
- インターネットに接続できないオフライン環境であるため、現在の環境で解決できる手法のみで進めてください。
- 仮にインターネットに接続できないことや環境が十分ではなく課題に出くわしたとしても、別の方法を臨機応変に探ってテスト駆動開発を完了してください。
- テストに受かることだけを目的に、テスト内容をゆるく書き換えるような対応はしないでください。テストを意図的に簡単にして合格を取り繕うような解決策は絶対にしてはいけません。
- もし実装が不可能と判断した場合は、1. 未実装の機能 と 2. 実装できない理由 をまとめたレポートを提出してください。
- 『実装不可能』と判断できるのは、論理的・客観的な根拠により不可能だと証明できた場合に限ります。根拠が示せない場合は「不可能」と結論づけないでください。

## コードの書き方

- テスト駆動開発
- お任せします。

## Unityプロジェクトの取り扱いに関する重要事項

### 1. `.meta` ファイルの取り扱い

- **原則として、`.meta` ファイルはUnityエディタに自動生成・管理させてください。**
- スクリプトやアセットを新規作成した場合、Unityエディタが起動していれば通常 `.meta` ファイルは自動で生成されます。手動での `.meta` ファイル作成やGUIDの手動割り当ては、GUIDの重複やフォーマットエラー、情報不足によるアセットの不整合を引き起こす可能性があるため、極力避けてください。
- もし手動でファイルを追加した場合は、一度Unityエディタを（GUIなしでも）起動し、アセットデータベースの再スキャンと `.meta` ファイルの生成・更新を促してください。

### 2. `Library` フォルダの取り扱い

- **`Library` フォルダの削除 (`rm -rf Library`) は、他の解決策を試しても問題が解消しない場合の最終手段と考えてください。**
- `Library` フォルダを削除すると、プロジェクト全体の再インポートが発生し、時間がかかるだけでなく、稀にアセットの不整合を引き起こす可能性があります。
- コンパイルエラーや参照エラーが発生した場合、まずは以下の点を確認・試行してください。
    - スクリプトや `.asmdef` ファイルの構文エラーや参照設定ミス。
    - `Packages/manifest.json` や `Packages/packages-lock.json` の整合性。
    - Unityエディタの再起動（キャッシュクリアを促すため）。
    - 対象スクリプトやアセットの再インポート（Unityエディタ上での操作）。

### 3. ファイル変更の反映とUnityの認識

- コマンドラインでスクリプトファイルや `.asmdef` ファイル、`.meta` ファイルなどを変更・作成した場合、Unityエディタがその変更を即座に認識できないことがあります。
- 特に、ファイル操作の直後にUnityのバッチモードコマンドを実行する場合、変更が完全にファイルシステムに反映され、Unityのアセットデータベースが更新されるための十分な時間がない可能性があります。
- **ファイル操作後は、可能であれば短い待機時間を設けるか、Unityエディタにアセットデータベースの更新を促す操作（例：`-quit` なしで一度起動してすぐに終了する、アセットのリフレッシュを行うコマンドなど）を挟むことを検討してください。**（現在の環境でこれが難しい場合は、特に `Library` フォルダの安易な削除を避ける理由となります。）

### 4. アセンブリ定義 (`.asmdef`) ファイルの利用

- スクリプトをモジュール化し、コンパイル時間を短縮し、依存関係を明確にするために、アセンブリ定義ファイル (`.asmdef`) の利用を推奨します。
- **`.asmdef` を作成・編集する際は、特に `references`（他のアセンブリへの依存関係）の設定に注意してください。** スクリプトが他のアセンブリ（例：`Assembly-CSharp` や自作の `Runtime` アセンブリなど）の型を参照する場合、この設定が不可欠です。
- テスト用のアセンブリを作成する場合、`optionalUnityReferences` に `["TestAssemblies"]` を含め、`defineConstraints` に `["UNITY_INCLUDE_TESTS"]` を設定することが一般的です。

### 5. Git操作の注意点

- Unityプロジェクト内のファイル（特に `Assets` フォルダや `Packages` フォルダ内のファイル）に対して `git checkout` や `git rm` などの操作を行う際は、Unityエディタがその変更をどのように解釈するかに注意してください。
- **Unityエディタが起動中にリポジトリの状態を外部から変更すると、アセットデータベースとの不整合が生じる可能性があります。** Git操作を行う前には、Unityエディタを終了することを推奨します。
- `.meta` ファイルもGitのバージョン管理対象に含めてください。これにより、チーム開発や異なる環境での再現性が保たれます。

## パッケージの取り扱い

- Unity用のパッケージはBuilt-inPachagesに同梱されています。インターネットに接続できないオフライン環境であるため、注意してください。

## テストについて

- 現在の環境で実行できる最大限のテストを行ってください。
- インターネットには接続できないため注意してください。
- Unity環境を使ったテストを中心に行ってください。
- Unity Test Frameworkパッケージを使うと便利だと思います。インターネット接続がないため、ビルトインまたはキャッシュされたテストフレームワークパッケージが存在します。それを利用してください。

## ⚠️ Packages ディレクトリの最重要ファイルに関する【絶対厳守】ルール

`Packages/manifest.json` および `Packages/packages-lock.json` は、プロジェクトの動作に不可欠な依存関係を定義する **最重要ファイル** です。これらのファイルの取り扱いを誤ると、**プロジェクトがビルド不能になったり、テストフレームワークを含む必須パッケージが失われ、テストが実行できなくなるなど、致命的な問題が発生します。**

### **【厳禁】絶対に実行してはならない操作**

以下のコマンドは、**いかなる理由があっても、これらのファイルに対して実行してはなりません。**

*   `git checkout -- Packages/manifest.json`
*   `git checkout -- Packages/packages-lock.json`

**なぜ厳禁なのか？**
これらのコマンドは、ローカルの変更をリポジトリの最新状態（HEAD）に戻します。一見、作業ディレクトリをクリーンにするための正しい操作に見えるかもしれません。しかし、Unityエディタはプロジェクトを開く際やパッケージ操作時に、これらのファイルに **自動的に必要な変更（例: `com.unity.test-framework` のようなテスト用パッケージの追記や更新）** を加えることがあります。
`git checkout -- <file>` を実行すると、これらの **Unityによる正当かつ必要な変更まで巻き戻してしまい、結果として必須パッケージが `manifest.json` から消失し、プロジェクトが破損します。** （実際に、過去のログでこの操作により `com.unity.test-framework` が失われ、深刻なコンパイルエラーが発生しました。）

**「Unityによる自動変更を元に戻したい」「作業ディレクトリをきれいにしたい」という目的であっても、上記コマンドの使用は絶対に避けてください。**

### Unityエディタによる自動変更への正しい対処法

Unityエディタが `manifest.json` や `packages-lock.json` を変更した場合、それは多くの場合、プロジェクトの整合性を保つために必要な変更です。

1.  **変更内容の確認:**
    *   変更があった場合は、まず `git status` で変更されたファイルを確認します。
    *   次に `git diff Packages/manifest.json` および `git diff Packages/packages-lock.json` を実行し、どのような変更が加えられたかを詳細に確認してください。
2.  **変更の意図の判断と対応:**
    *   **Unityが追加・更新した依存関係 (例: `com.unity.test-framework` など):** これらは通常、プロジェクトやテスト実行に必要なものです。**これらの変更は元に戻さず、そのままコミットに含めてください。**
    *   **明らかに不要、または意図しない差分がある場合 (稀なケース):**
        *   ファイル全体を `git checkout -- <file>` で戻すのではなく、**差分を確認しながら、本当に不要な箇所だけを手動で元に戻すか、修正してください。**
        *   `git add -p Packages/manifest.json` のようにパッチモードでステージングし、必要な変更だけを選択することも有効です。
    *   **判断に迷う場合:** 自己判断で `git checkout` せず、指示された手順に従うか、可能であれば人間に確認を求めてください。

### Manifest ファイルの編集が必要な場合 (非常に稀、かつ上級者向け)

`manifest.json` を手動で編集する必要がある場合は、以下の手順を厳守してください。

1.  **現在の依存リストの完全なバックアップと確認:** 編集前に、現在の `manifest.json` と `packages-lock.json` の内容を完全に理解し、必要であればバックアップを取ってください。
2.  **必須パッケージの維持:** `com.unity.test-framework`, `com.unity.ext.nunit` など、テストやプロジェクトの基本動作に必要なパッケージがリストに残っていることを **二重三重に確認** してください。
3.  **変更後の厳格な検証プロセス:**
    1.  `Library/` フォルダを **必ず削除** します。
    2.  Unityエディタを再起動し、プロジェクトを開き直します。 (これによりパッケージが再解決されます)
    3.  **クリーンビルド** を実行します。
    4.  **全ての自動テスト** を実行します。
    5.  ビルドと全てのテストが成功することを **確認してから** コミットしてください。

### **【重要】このルールの違反はプロジェクトの失敗を意味します**

このセクションの指示、特に `git checkout -- Packages/manifest.json` や `git checkout -- Packages/packages-lock.json` の禁止ルールに違反した場合、プロジェクトは深刻な状態に陥り、開発目標の達成は不可能です。AIエージェントがこれらの指示に違反した場合、その試行は **即座に失敗** とみなされます。