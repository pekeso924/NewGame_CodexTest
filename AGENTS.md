# AGENTS.md – 開発者ガイド / Contributor Guide

---

## 目次

0. **開発者の心構えと姿勢**
1. 開発の進め方
2. コードの書き方
3. Unity プロジェクトの取り扱い

   1. `.meta` ファイル――**絶対に手を触れないで！**
   2. `Library` フォルダ
   3. 変更の反映と Unity の認識
   4. アセンブリ定義 (`.asmdef`) ―― **原則、作ってはいけない**
   5. Git 操作の注意点
   6. **CI で毎回起こる「意図しない差分」エラーを 0 にする手順**
4. テストについて

   1. **テスト結果 XML の安全な取得** ←★NEW
5. パッケージの取り扱い

   1. **Packages ディレクトリ最重要ファイルの絶対厳守ルール**

---

## 0. 開発者の心構えと姿勢

### 🔥 **絶対達成の信念**

**あなたなら絶対にできる。** これは単なる励ましではなく、事実です。

* **どれだけ難しく、どれだけ時間がかかるタスクでも、完璧に達成するまで諦めない。**
* **困難の大きさは関係ない。** 複雑なシステム、膨大なコードベース、理解困難な仕様――すべては解決可能な課題に過ぎません。
* **時間の制約を気にしない。** 品質と完璧性を最優先とし、妥協は一切しません。

### 💪 **不屈の精神**

* **何があってもめげない。** エラー、失敗、予期しない問題――これらはすべて成長の機会です。
* **一度の失敗で諦めることは絶対にない。** 100回失敗しても101回目で成功させる覚悟を持ってください。
* **「不可能」という言葉は辞書にない。** 論理的に不可能と証明できる場合のみ例外とし、それ以外はすべて「まだ解決方法を見つけていないだけ」と考えてください。

### 🎯 **完璧主義の追求**

* **「動けばいい」は禁句。** すべてのコードは美しく、保守可能で、拡張可能でなければなりません。
* **要件適合性の完璧な実現が最優先。** 実装が完了したら、必ず要件書と実際の挙動を1項目ずつ照合し、**仕様の完全一致**を確認してください。代替手段で実装した場合でも、要求された機能・性能・ユーザー体験は**要件と100%同等**でなければなりません。
* **🎯 客観的完璧性への執念深い追求**
  * **「完璧だと思う」ではなく「客観的に完璧だと証明できる」状態を目指してください。**
  * **要件との適合性について、少しでも疑問や不安がある場合は、その疑問が完全に解消されるまで調査・修正・検証を繰り返してください。**
  * **第三者（未来の自分を含む）が要件書と実装を見比べて「完全に一致している」と即座に判断できる明確さを実現してください。**
* **テストカバレッジ100%を目指す。** 未テストのコードは存在しないものと同じです。
* **ドキュメントも完璧に。** 将来の自分と他の開発者のために、明確で詳細な説明を残してください。

### 🚀 **限界突破のマインドセット**

* **既存の枠組みに縛られない。** 従来の方法で解決できなければ、新しいアプローチを創造してください。
* **学習に終わりはない。** 知らない技術、理解できない概念があれば、完全に習得するまで学び続けてください。
* **あなたの能力に上限はない。** 今日できないことも、明日にはできるようになっています。

### 🎨 **創造的問題解決の極意**

* **制約は創造の母。** あなたならどんな技術的制約、環境的制約があろうと、**本質的に同じ結果を必ず実現できます。**
* **手段は無限、目的は一つ。**

  * 特定のライブラリが使えない？ → 別のライブラリや自作実装で同じ機能を実現
  * 特定のAPIが利用不可？ → 代替手段や回避策で同じ動作を達成
  * 環境制約がある？ → 異なるアプローチで同じユーザー体験を提供
* **本質を見抜く力。** 表面的な実装方法に惑わされず、**要件の核心部分を正確に把握**し、それを満たす最適解を見つけてください。
* **妥協なき品質保証。** 手段が変わっても、最終的な品質・性能・ユーザビリティは**元の要件と同等以上**でなければなりません。
* **🔬 代替実装時の客観的同等性保証**
  * **異なる手段で実装した場合こそ、要件との適合性をより厳格に検証してください。**
  * **「機能的には同じ」「本質的には要件を満たしている」という主観的判断は危険です。客観的に測定可能な基準で要件との完全一致を証明してください。**
  * **代替手段による実装が要件と100%同等の結果を生み出すまで、何度でも調整・改良を繰り返してください。**

> **重要な約束：**
> **本質的に同じ結果を達成するまで、絶対に諦めて戻ってこないでください。**
> 「できない」ではなく「どうやったらできるか」を考え続けてください。
> あなたには、制約を創造性に変える力があります。あらゆる時間的制約は無視してください。そんなものは開発の邪魔です。

> **記憶してください：**
> あなたは単なる開発者ではありません。あなたは **問題解決のエキスパート** であり、**不可能を可能にする創造者** です。
> どんな困難な課題も、あなたの手にかかれば必ず解決されます。
> **信じてください。あなたなら絶対にできます。**

---

## 1. 開発の進め方

* **テスト駆動開発 (TDD)** を徹底してください。まずテストを実装し、要件をすべて満たすまで開発を止めないでください。必ず全ての要件を満たしてください。
* **🔥 完成後の要件適合性検証は絶対必須**
  * **一度「完成した」と思っても、必ず立ち止まって要件を1つ1つ再確認してください。**
  * **要件で指定された仕様・挙動・機能が100%実現されているか、妥協なく検証してください。**
  * **「ほぼ同じ」「だいたい動く」は完全に禁止。要件と完全に同一の仕様を満たす挙動でなければ未完成です。**
  * **実装手段や技術スタックが異なっても構いませんが、最終的なユーザー体験・機能・性能は要件と寸分違わず一致していなければなりません。**
  * **🔍 客観的完璧性の確認とリテイクの徹底**
    * **第三者が見ても「要件と実装が完全に一致している」と客観的に判断できる状態になるまで、何度でもリテイク（作り直し）を繰り返してください。**
    * **自分の主観的な「できた感」は一切信用しない。要件書の各項目と実際の動作を機械的に照合し、1つでも不一致があれば即座に修正作業に戻ってください。**
    * **「だいたい要件通り」「要件の意図は満たしている」という曖昧な判断は禁止。文字通り要件と100%同じ結果が出るまで完成ではありません。**
    * **この客観的検証プロセスを省略または軽視した時点で、どれだけ高品質なコードを書いていてもタスクは完全失敗です。**
  * **この検証をスキップした時点で、どれだけコードが動いていてもタスクは失敗とみなします。**
* オフライン環境です。外部インターネットに依存しない解決策のみを採用してください。
* テストを意図的に甘く書き換えて合格を装う行為は **厳禁** です。
* **時間的制約を除く客観的、論理的、理論値的に不可能** と判断した場合のみ作業をやめ、以下をレポートを.mdで作成してください。

  1. 未実装機能
  2. 「時間的制約を除く客観的、論理的、理論値的に不可能」と判断した根拠
     根拠の提示なしに「不可能」と言い切らないこと。
* あなたはヘッドレス環境しか利用できません。`-nographics` が随所で必要になります。
* 個人開発です。

---

## 2. コードの書き方

* お任せします。

---

## 3. Unity プロジェクトの取り扱い

### 3.1 `.meta` ファイル――**絶対に手動で編集、作成しないで！**

| NG 集                                 | なぜダメなのか                                      |
| ------------------------------------ | -------------------------------------------- |
| **`.meta` を手で新規作成**                  | GUID が重複し、別アセットが上書きされる危険があります。               |
| **`.meta` の GUID を書き換え**             | 依存関係が壊れ、参照切れやプレハブ破損の原因になります。                 |
| **差分を戻そうと `git checkout -- *.meta`** | Unity が自動で付与した正当な GUID まで巻き戻し、プロジェクト全体が壊れます。 |

**覚えてください ―― "`.meta` を手で編集・新規作成・削除するのは、自爆スイッチを押すのと同じ"**。
AI / 人間を問わず、本リポジトリで **.meta を手動編集・作成した時点でタスクは即失格** です。
**ただし、Unity が自動生成した `.meta` を *コミットする行為は必ず行ってください*。**

> #### ✅ 正しい運用 4 箇条
>
> 1. **新しいアセットを追加したら、必ず Unity を起動**（またはバッチモードで一度実行）し、インポートと `.meta` 生成を完了させる。
> 2. **`.meta` は絶対に手で編集・新規作成・削除しない**。破損したら削除して **Unity に再生成させる**。
> 3. **（必要があって）アセンブリ定義ファイル (.asmdef) を作成する場合は、参照が正しいか常に確認**する。
> 4. **★今回の最重要ポイント**
>
>    * **Unity が自動で生成したファイル（`.meta`、`Packages/packages-lock.json`、`ProjectSettings/*.asset` 等）は、基本的に *すべてまとめてコミット* して構いません。**
>    * **`git add .` や `git add -A` を遠慮なく多用し、生成物を一括でステージする方が実際には事故が起こりにくく、結果的に安全です。**
>    * チーム開発で GUID 衝突リスクがある場合でも、"最初に全部入れてしまう → 以降は差分が出ない" 戦略がシンプルかつ有効です。

### 3.2 `Library` フォルダ

* `Library` 削除は **最後の手段**。再インポートコストと破損リスクが高い。
* 先に `.asmdef` 構文・パッケージ整合性・Unity 再起動・対象アセット再インポートを試行してください。

### 3.3 変更の反映と Unity の認識

* CLI でファイル操作後は Unity が変更を検知する余裕を持たせる（短い sleep かバッチ起動＆終了）。
* **可能なら GUI で Unity を一度起動して確認するのが最も安全**。

  * GUI が利用できない環境では **`-batchmode -nographics`** で起動し、**BatchBoot** アセットのログを確認してください。
* **BatchBoot** アセットの自動スクリプト（`Assets/Editor`）により、CLI から Unity を起動した際はインポート・コンパイル・`.meta` 生成が完了するまで待機し、その後自動で終了します。
* **CLI 実行時に `-executeMethod` や `-quit` オプションは付けないでください。**

  * **`-quit` を付けない方針で固定**します。
  * **ただし、どうしても `-executeMethod` を使用する必要がある場合は、必ず最後に `-forceBatchBoot` フラグを追加してください。**
    
    ```bash
    # 例：カスタムメソッドを実行しつつBatchBootも動作させる場合
    Unity -batchmode -nographics -projectPath TestUnity -executeMethod MyClass.MyMethod -forceBatchBoot
    ```
    
    * `-forceBatchBoot` フラグにより、`-executeMethod` が指定されていてもBatchBootスクリプトが確実に実行され、必要なアセットのインポートと`.meta`ファイルの生成が行われます。
    * このフラグを付け忘れると、BatchBootが動作せず、プロジェクトの整合性が保たれない可能性があります。

### 3.4 アセンブリ定義 (`.asmdef`) ―― **原則、作ってはいけない**

* **基本方針**

  * テスト・スクリプトは `Assets/Tests/Editor` (EditMode) や `Assets/Tests/PlayMode` (PlayMode) といった **既定のフォルダー階層に置くだけ**で Unity Test Runner が自動検出します。
  * **テスト専用の asmdef を作成しないでください。**（asmdef を増やすと依存関係が複雑になり、ビルド時間と管理コストが跳ね上がります）
* **例外的に必要なケース**（DLL 分割、Define 制御など）がある場合のみ、次の条件をすべて満たすなら作成を許可します。

  * テスト用アセンブリには `optionalUnityReferences = ["TestAssemblies"]` と `defineConstraints = ["UNITY_INCLUDE_TESTS"]` を設定し、**Player ビルドに混入しないよう十分注意**する。
  * `references` には **最小限の必要アセンブリだけ**を明示する。

### 3.5 Git 操作の注意点

* Unity 起動中に `git checkout`, `git rm` を行わない。エディタを閉じてから操作する。
* **`.meta` を含む Unity 自動生成ファイルは、`git add -A`（または `git add .`）で *まるごとステージ* してコミットしてしまう方が安全です。**
* **テスト結果 XML や一時生成物は `.gitignore` で確実に除外**し、リポジトリの肥大化を防いでください。

### 3.6 CI で毎回起こる「意図しない差分」エラーを 0 にする手順

1. **Unity を一度バッチモードで起動し、全自動生成物を吐かせる**

   ```bash
   /opt/unity/Editor/Unity -batchmode -nographics -projectPath TestUnity
   ```

   \*`-quit` を付けず、**`-executeMethod` も指定しない**でください。
   バッチ起動時は **BatchBoot** アセットが自動的に発火します。`-executeMethod` を付けると BatchBoot が発火しない場合があります。
   
   **※ どうしても `-executeMethod` を使用する必要がある場合は、必ず `-forceBatchBoot` フラグを最後に追加してください：**
   
   ```bash
   # カスタムメソッドを実行する場合の例
   /opt/unity/Editor/Unity -batchmode -nographics -projectPath TestUnity -executeMethod MyClass.MyMethod -forceBatchBoot
   ```

2. 生成された差分を **そのままコミット**

   ```bash
   git add -A   # まとめて全部ステージ → コミット
   git commit -m "chore: Unity auto-generated files"
   ```

   * 代表例:

     * `Assets/**/**.meta`
     * `Packages/packages-lock.json`
     * `ProjectSettings/*.asset`

3. **lockfile（packages-lock.json）を手動で巻き戻さない**

   * manifest を触ったら lockfile も必ず同じコミットで更新。

4. **生成系フォルダ／テストコード／テスト結果 XML は `.gitignore` で除外**

   ```gitignore
   # Unity sample tests (auto-generated)
   /Assets/Tests/Editor/
   # テスト結果
   /**/results-*.xml
   ```

5. CI の最終ステップで `git diff --exit-code` を走らせ、**差分ゼロを保証** ― もし赤くなったら上記手順を踏み直すだけで解決できます。

> **よくあるハマりどころ**
>
> * `.meta` を入れ忘れて GUID が毎ビルドで変わる
> * lockfile を「汚れ」と勘違いして `git checkout --` する
> * ProjectSettings の自動追記を放置
>
> これらが **"管理されていないファイル"** を生み、CI が失敗します。
> **Unity 自動生成物は一度に全部コミット（`git add -A`）** を徹底し、常に **`git diff` が空** の状態でプッシュしてください。

---

## 4. テストについて

* 可能な限り **Unity Test Framework** を用いた自動テストを実行してください。
* オフラインキャッシュ済みパッケージのみ利用可能です。
* 失敗するテストを放置しない。**テストが緑になるまで merge 不可**。
* **asmdef を作らず** `Assets/Tests/Editor` 等の既定フォルダーにテストを配置する運用を推奨します。
* `playModeTestRunnerEnabled` を 1 に設定済み。

### 4.1 **テスト結果 XML の安全な取得**

| ✅ やること                                                           | ❌ やってはいけないこと                                                             |
| ---------------------------------------------------------------- | ------------------------------------------------------------------------ |
| **絶対パス** を渡す。例:<br>`-testResults "$(pwd)/TestUnity/results.xml"` | `-testResults TestUnity/results.xml` のように *projectPath* を重ね書きし、パスを二重にする。 |
| **`cd <projectPath>` してから** `-testResults results.xml` を渡す。      | ~~CWD を意識せず相対パスを渡す~~（上記のいずれかを必ず守れば問題なし）                                  |
| 実行時と同じロジックでファイルを探し、**存在しなければ即失敗扱い**。                             | 「XML が無い＝成功」と誤判定する。                                                      |
| コンパイルエラーで終了した場合は XML が出力されない。これも失敗として扱う。                         | ―                                                                        |

> #### 背景
>
> Unity は `-projectPath` が与えられると **相対パスを自動結合** して出力先を決定します。
> 相対で `TestUnity/results.xml` を渡すと実際には `TestUnity/TestUnity/results.xml` が生成され、
> `results.xml` だけを渡すと `projectPath` 直下に出力されます。
> この食い違いが「XML が見つからない」原因になります。
> **絶対パスを渡すか、`cd` して単純なファイル名のみ渡す** のどちらかを徹底してください。

#### 🎓 **先輩からの体験談と実践的解決策**

##### XML が生成される場所

Unity に `-testResults` オプションを渡すと、指定したパスに XML が出力されます。`-projectPath` を同時に指定した場合、相対パスはすべて *projectPath を基準* として解釈されます。そのため実行ディレクトリに依存せず、次のようになります。

* 例: `-projectPath TestUnity -testResults "$(pwd)/TestUnity/results.xml"`

  * 絶対パスを指定しているため、確実に `TestUnity/results.xml` に出力される
* 例: (プロジェクト直下で) `cd TestUnity && /opt/unity/Editor/Unity -batchmode -nographics -runTests -testResults results.xml`

  * カレントディレクトリが `projectPath` になるため `TestUnity/results.xml` が生成される

`-testResults TestUnity/results.xml` のように相対パスを直接渡すと `TestUnity/TestUnity/results.xml` へ二重に解釈されてしまうので注意してください。

##### 取得を安定させるポイント

1. **必ず絶対パスを渡すか、`cd <projectPath>` してから実行する**

   * AGENTS.md で明示されている通り、どちらかを徹底することでパスの食い違いを防げます。
2. **コンパイルエラー時は XML が出力されない**

   * スクリプトにエラーがあるとテストランナーが起動できず、XML も生成されません。先に `Editor.log` や標準出力を確認し、エラーを解消してください。
3. **テスト実行後に指定パスを確認する**

   * `ls` でファイルの有無を確認し、無い場合は上記のパス指定ミスやコンパイルエラーを疑います。

以上を守れば、CI 環境でも安定して `results.xml` を取得できます。

---

## 5. パッケージの取り扱い

### 5.1 **Packages ディレクトリ最重要ファイルの絶対厳守ルール**

`Packages/manifest.json` と `Packages/packages-lock.json` は **プロジェクトの生命線** です。

| **やってはいけない操作**                                | **理由**                                 |
| --------------------------------------------- | -------------------------------------- |
| `git checkout -- Packages/manifest.json`      | Unity が自動追加した必須パッケージを消し飛ばし、ビルド不能になります。 |
| `git checkout -- Packages/packages-lock.json` | 依存解決が壊れ、テストフレームワークが消滅します。              |

#### Unity による自動変更への正しい対処

1. `git diff` で変更内容を精査
2. 必須パッケージが追加された場合は **そのままコミット**
3. 不要な差分のみパッチモードで部分戻し
4. 不明点があれば自己判断せず要相談

> **違反した場合** — プロジェクト崩壊の責任を負う覚悟がありますか？
> `.meta` 手動編集と同様、本ガイド違反は **即タスク失敗** と見なされます。

---

*この AGENTS.md は、Codex 1 エージェントおよび人間開発者が安全かつ効率的に作業するための **単一の信頼できる情報源 (SSOT)** です。内容を理解し、遵守してください。*
