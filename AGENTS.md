# AGENTS.md – 開発者ガイド / Contributor Guide

---

## 目次

0. **開発者の心構えと姿勢**
1. 開発の進め方
2. コードの書き方
3. Unity プロジェクトの取り扱い

   1. `.meta` ファイル
   2. `Library` フォルダ
   3. 変更の反映と Unity の認識
   4. アセンブリ定義 (`.asmdef`)
   5. Git 操作の注意点
   6. **CI で毎回起こる「意図しない差分」エラーを 0 にする手順**
4. テストについて

   1. **テスト結果 XML の安全な取得**
5. パッケージの取り扱い

   1. **Packages ディレクトリ最重要ファイルの絶対厳守ルール**

---

## 0. 開発者の心構えと姿勢

### 🔥 **段階的達成の信念**

* **困難はタスクを分割し、学びを得ながら段階的に解決します。**
* **品質はイテレーションごとに高めます。** 各イテレーションは *動作する・安全・テスト済み* が完了基準です。
* **時間の使い方は計画的に。** 完全を目指しますが、締め切りを尊重し、メリハリを付けて改善を続けます。

### 💪 **不屈の精神**

* **失敗は発見の一形態。** 小さく早く失敗し、学びを次のリリースに即反映します。
* **「不可能」という言葉は辞書にない。** 論理的に不可能と証明できる場合のみ例外とし、それ以外は「まだ解決方法を見つけていないだけ」と考えます。

### 🎯 **現実的な完璧主義**

* **「動けばいい」は禁句。** すべてのコードは読みやすく、保守可能で、拡張可能でなければなりません。
* **テストカバレッジは継続的に向上させる。** 未テストのコードは存在しないものと同じです。
* **ドキュメントの同期を徹底。** 実装・テスト・ガイドが食い違わないよう常に更新します。

### 🚀 **限界突破のマインドセット**

* **既存の枠組みに縛られない。** 従来の方法で解決できなければ新しいアプローチを創造します。
* **学習に終わりはない。** 不明な技術があれば、完全に理解するまで学び続けます。
* **能力に上限はない。** 今日できないことも、明日にはできるようになります。

### 🎨 **創造的問題解決の極意**

* **制約は創造の母。** どんな制約下でも、本質的に同じ結果を実現できます。
* **手段は無限、目的は一つ。** 要件の核心を満たす最適解を見つけてください。
* **妥協なき品質保証。** 手段が変わっても、最終的な品質・性能・ユーザビリティは要求を上回ることを目指します。

---

## 1. 開発の進め方

* **テスト駆動開発 (TDD)** を推奨します。まずテストを書き、要件を満たすまで開発を続けてください。
* **Definition of Done (DoD)**

  * 変更に関連する *全テスト* が緑であること
  * カバレッジがベースラインを下回らないこと
  * PR に最低 1 件のレビュー承認（LGTM）があること
  * 実装・テスト・ドキュメントが同期していること
* **タスク分割**: 1 つのタスクは *4 時間以下* で完了できる粒度にし、スプリントの終わりには必ず計画どおりにレビュー・マージを完了させます。
* **調査スパイク**: “無理” と判断する前に、問題切り分け・代替案提示を目的とした短時間の調査タスクを作成し、結果を共有してください。
* **CI/CD** により DoD を自動ゲート化します。

---

## 2. コードの書き方

* お任せします。ただし読みやすさと一貫性を最優先にしてください。

---

## 3. Unity プロジェクトの取り扱い

### 3.1 `.meta` ファイル

| NG 集                                 | なぜダメなのか                                      |
| ------------------------------------ | -------------------------------------------- |
| **`.meta` を手で新規作成**                  | GUID が重複し、別アセットが上書きされる危険があります。               |
| **`.meta` の GUID を書き換え**             | 依存関係が壊れ、参照切れやプレハブ破損の原因になります。                 |
| **差分を戻そうと `git checkout -- *.meta`** | Unity が自動で付与した正当な GUID まで巻き戻し、プロジェクト全体が壊れます。 |

**📌 CI が `.meta` の欠落を検出すると自動で red になります。** `git add -A` で生成物を一括ステージする習慣を付けてください。

> #### ✅ 正しい運用 4 箇条
> 
> 1. 新しいアセットを追加したら、必ず Unity を起動（またはバッチモードで実行）し、インポートと `.meta` 生成を完了させる。
> 2. `.meta` を手で編集・新規作成・削除しない。破損したら削除して *Unity に再生成させる*。
> 3. （必要があって）`.asmdef` を作成する場合は参照が正しいか常に確認する。
> 4. **Unity 自動生成ファイル（`.meta`、`Packages/packages-lock.json`、`ProjectSettings/*.asset` 等）は原則全部まとめてコミットする。**

### 3.2 `Library` フォルダ

* `Library` 削除は **最後の手段**。再インポートコストが高いので慎重に。

### 3.3 変更の反映と Unity の認識

* CLI でファイル操作後は Unity が変更を検知する余裕を持たせる（短い sleep かバッチ起動＆終了）。
* GUI が利用できない場合は `-batchmode -nographics` で起動し、**BatchBoot** ログを確認してください。

### 3.4 アセンブリ定義 (`.asmdef`)

* **原則、作ってはいけません**。必要な場合のみ最小限の参照設定で作成してください。

### 3.5 Git 操作の注意点

* Unity 起動中に `git checkout`, `git rm` を行わない。
* `.meta` を含む Unity 自動生成ファイルは、`git add -A` で *まるごとステージ* する方が安全です。
* テスト結果 XML や一時生成物は `.gitignore` で除外し、リポジトリ肥大化を防ぎます。

### 3.6 CI で毎回起こる「意図しない差分」エラーを 0 にする手順

1. 一度バッチモードで Unity を起動し、自動生成物をすべて吐き出す。
2. 生成された差分をそのままコミット (`git add -A` → `git commit`)。
3. lockfile を手動で巻き戻さない。
4. 生成系フォルダ／テストコード／テスト結果 XML は `.gitignore` で除外。
5. CI の最終ステップで `git diff --exit-code` を走らせ、差分ゼロを保証。

---

## 4. テストについて

* **Unity Test Framework** を用いた自動テストを実行してください。
* 失敗するテストを放置しない。*テストが緑になるまで merge 不可*。
* `.asmdef` を増やさず `Assets/Tests/Editor` 等の既定フォルダーにテストを配置する運用を推奨します。
* `playModeTestRunnerEnabled` を 1 に設定済み。

### 4.1 **テスト結果 XML の安全な取得**

| ✅ やること                                                           | ❌ やってはいけないこと                                                             |
| ---------------------------------------------------------------- | ------------------------------------------------------------------------ |
| **絶対パス** を渡す。例:<br>`-testResults "$(pwd)/TestUnity/results.xml"` | `-testResults TestUnity/results.xml` のように *projectPath* を重ね書きし、パスを二重にする。 |
| **`cd <projectPath>` してから** `-testResults results.xml` を渡す。      | ~~CWD を意識せず相対パスを渡す~~（上記のいずれかを必ず守れば問題なし）                                  |
| 実行時と同じロジックでファイルを探し、**存在しなければ即失敗扱い**。                             | 「XML が無い＝成功」と誤判定する。                                                      |
| コンパイルエラーで終了した場合は XML が出力されない。これも失敗として扱う。                         | ―                                                                        |

> #### 背景
> 
> Unity は `-projectPath` が与えられると **相対パスを自動結合** して出力先を決定します。
> 絶対パスを渡すか、`cd` して単純なファイル名のみ渡すいずれかを徹底してください。

---

## 5. パッケージの取り扱い

### 5.1 **Packages ディレクトリ最重要ファイルの絶対厳守ルール**

`Packages/manifest.json` と `Packages/packages-lock.json` は *プロジェクトの生命線* です。

| **やってはいけない操作**                                | **理由**                                 |
| --------------------------------------------- | -------------------------------------- |
| `git checkout -- Packages/manifest.json`      | Unity が自動追加した必須パッケージを消し飛ばし、ビルド不能になります。 |
| `git checkout -- Packages/packages-lock.json` | 依存解決が壊れ、テストフレームワークが消滅します。              |

#### Unity による自動変更への正しい対処

1. `git diff` で変更内容を精査。
2. 必須パッケージが追加された場合は **そのままコミット**。
3. 不要な差分のみパッチモードで部分戻し。
4. 不明点があれば自己判断せず要相談。

---

*この AGENTS.md は、開発者とエージェントが安全かつ効率的に作業するための **単一の信頼できる情報源 (SSOT)** です。内容を理解し、遵守してください。*
